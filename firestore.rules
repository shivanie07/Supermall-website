rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    match /shops/{shopId} {
      allow create: if request.auth != null
        && request.resource.data.ownerId == request.auth.uid
        && request.resource.data.name is string
        && request.resource.data.category is string
        && request.resource.data.floor is string
        && request.resource.data.contact is string;

      allow read: if true;  // Or restrict to request.auth != null
      allow update, delete: if request.auth != null
        && resource.data.ownerId == request.auth.uid;
    }
    
    match /products/{productId} {
      allow read: if true;

      allow create: if request.auth != null
        && request.resource.data.shopId is string
        && request.resource.data.name is string
        && get(/databases/$(database)/documents/shops/$(request.resource.data.shopId)).data.ownerId == request.auth.uid;

      allow update, delete: if request.auth != null
        && get(/databases/$(database)/documents/shops/$(resource.data.shopId)).data.ownerId == request.auth.uid;
    }
    
    // Offers collection: allow public read, but only shop owner can create/update/delete offers
    match /offers/{offerId} {
      allow read: if true;

      allow create: if request.auth != null
        && request.resource.data.shopId is string
        && get(/databases/$(database)/documents/shops/$(request.resource.data.shopId)).data.ownerId == request.auth.uid;

      allow update, delete: if request.auth != null
        && get(/databases/$(database)/documents/shops/$(resource.data.shopId)).data.ownerId == request.auth.uid;
    }

    // Offer <-> Product links. Reads are public; creates/deletes only by shop owner who owns the offer's shop.
    match /offer_products/{linkId} {
      allow read: if true;

      allow create: if request.auth != null
        && request.resource.data.offerId is string
        && request.resource.data.productId is string
        && get(/databases/$(database)/documents/offers/$(request.resource.data.offerId)).data.shopId != null
        && get(/databases/$(database)/documents/shops/$(get(/databases/$(database)/documents/offers/$(request.resource.data.offerId)).data.shopId)).data.ownerId == request.auth.uid;

      allow delete: if request.auth != null
        && get(/databases/$(database)/documents/offers/$(resource.data.offerId)).data.shopId != null
        && get(/databases/$(database)/documents/shops/$(get(/databases/$(database)/documents/offers/$(resource.data.offerId)).data.shopId)).data.ownerId == request.auth.uid;
    }

    match /logs/{logId} {
      allow read: if false;               // nobody can read
      allow create: if true;              // anyone can write
      allow update, delete: if false;     // no updates/deletes
    }

    // All other collections require auth
    match /{document=**} {
      allow read, write: if request.auth != null;
    }

  }
}
